---
title: "Time-Varying Effectiveness of Three Covid-19 Vaccines in Puerto Rico"
author: 
  - R.A. Irizarry, M.M. Robles-Fontán, E.G. Nieves, and I. Cardona-Gerena 
#date: "`r format(Sys.time(), '%B %e, %Y')`"
output:
  bookdown::pdf_document2:
    number_section: FALSE
    toc: FALSE
linkcolor: blue
bibliography: references.bib
csl: lancet.csl
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE, fig.width = 9, fig.height = 3,  fig.align='center', out.extra = "", out.width = "100%")
options(digits = 3)
library(bibtex)
## 1157622 unique IDs molecular and antigens
## 1714424 unique IDs all

### Comirnaty - Pfizer-BioNTech BioNTech
### Moderna COVID-19 Vaccine - Moderna
### Janssen COVID-19 Vaccine - Johnson and Johnson
```

```{r, include=FALSE, echo=FALSE}
library(tidyverse)
library(lubridate)
library(splines)
library(kableExtra)
library(RColorBrewer)
library(scales)
library(flextable)
set_flextable_defaults(fonts_ignore=TRUE)
```

```{r, echo=FALSE, cache=TRUE}
source("wrangle.R")
source("prep-for-paper.R")
```

R.A. Irizarry, Ph.D., Corresponding Author

* Affiliations: Department of Data Science, Dana-Farber Cancer Institute, Department of Biostatistics, Harvard T.H. Chan School of Public Health
* Address: CLSB 11007, 450 Brookline Ave, Boston, MA 02215
* Email: rafael_irizarry@dfci.harvard.edu
* Phone number: 617-632-2454

M.M. Robles-Fontán, MS

* Affiliations: Digheontech, Inc. (until October 8, 2021), CDC Foundation-Puerto Rico Department of Health (since October 12, 2021)
* Address: Programa de Vacunación, Centro Médico Norte, Calle Periferial Interior, Bo. Monacillos Río Piedras, PR

E.G. Nieves, HSDG

* Affiliation: Puerto Rico Department of Health
* Address: Programa de Vacunación, Centro Médico Norte, Calle Periferial Interior, Bo. Monacillos Río Piedras, PR

I. Cardona-Gerena, MD

* Affiliation: Puerto Rico Department of Health
* Address: Programa de Vacunación, Centro Médico Norte, Calle Periferial Interior, Bo. Monacillos Río Piedras, PR

\newpage

# Abstract 

**Background** On July 15, 2020, with 58% of the population fully vaccinated, the start of a COVID-19 surge was being observed in Puerto Rico. On July 22, 2021, the government commenced imposing a series of strict vaccine mandates. Two months later, over 70% of the population was vaccinated, more than in any US state, and laboratory-confirmed SARS-CoV-2 had dropped substantially. The decision to impose mandates, as well as current Department of Health recommendations related to boosters, were guided by the data and time-varying effectiveness estimates presented here.

**Methods** Between December 15, 2020, when the vaccination process began in Puerto Rico, and `r format(analysis_last_day, "%B %e, %Y")`, `r make_pretty(sum(vax_tots))` individuals were fully vaccinated against COVID-19. During this period `r make_pretty(nrow(dat_cases_vax))` laboratory-confirmed SARS-CoV-2 infections have been reported. These data permitted us to quantify the outcomes of the immunization campaign and to compare effectiveness of the `r manu_labels[["MOD"]]` (Moderna), `r manu_labels[["PFR"]]` (Pfizer), and `r manu_labels[["JSN"]]` (J&J) vaccines.  We obtained vaccination status, SARS-CoV-2 test results, and COVID-19 hospitalizations and deaths, from the Department of Health. We fit statistical models that adjusted for time-varying incidence rates and age group to estimate time-varying vaccine effectiveness against lab-confirmed SARS-CoV-2 infection, and COVID-19 hospitalization and death. Code and data to reproduce the analyses are provided here: https://github.com/rafalab/vax-eff-pr. 

**Results**  At their peak, the `r manu_labels[["MOD"]]`, `r manu_labels[["PFR"]]`, and `r manu_labels[["JSN"]]` vaccines had an effectiveness of `r wa_eff$MOD$max` (95% CI: `r wa_eff$MOD$max.lo`-`r wa_eff$MOD$max.up`), `r wa_eff$PFR$max` (`r wa_eff$PFR$max.lo`-`r wa_eff$PFR$max.up`), and, `r wa_eff$JSN$max` (`r wa_eff$JSN$max.lo`-`r wa_eff$JSN$max.up`) respectively.  After five months, effectiveness waned to about `r round_wa_est_mod`, `r round_wa_est_pfr`, and `r round_wa_est_jsn`, respectively.  We found no evidence that effectiveness was different after the Delta variant became dominant. For those infected, the vaccines provided further protection against COVID-19 hospitalization and deaths across all age groups, and this conditional effect did not wane in time.

**Interpretation** The `r manu_labels[["MOD"]]` and `r manu_labels[["PFR"]]`  vaccines were highly effective across all age groups. They were still effective after five months although the protection against SARS-CoV-2 infection waned. The `r manu_labels[["JSN"]]` vaccine was effective but to a lesser degree compared to the mRNA vaccines. Although, conditional on infection, protection against adverse outcomes did not wane, the waning in effectiveness resulted in a decreased protection against serious COVID-19 outcomes across time.

**Funding** RAI's work was partly funded by NIH Grant R35GM131802.

\pagebreak



## Introduction 

The first COVID-19 case was first reported on December 31, 2019, and the race for a vaccine commenced shortly after. By fall 2020, there were several ongoing clinical trials for vaccines developed with full messenger RNA (mRNA) technology. @pardi2018mrna 
In the United States, three of the currently used COVID-19 vaccines were shown to be highly effective against SARS-CoV-2 outcomes in randomized double-blind trials. A two-dose series of `r manu_labels[["PFR"]]` (Pfizer) COVID-19 vaccine was shown to be 95% efficacious against symptomatic COVID-19 in individuals 16 and older. 
@CTPFR 
Similarly, a two-dose series of `r manu_labels[["MOD"]]` COVID-19 provided 94% efficacy against symptomatic COVID-19 for those 18 and older. 
@CTMOD Finally, a single-shot of the `r manu_labels[["JSN"]]` COVID-19 vaccine provided 66% protection against moderate to severe COVID-19 disease for individuals 18 years and older. 
@CTJanssen These findings led to emergency use authorizations (EUA) by the Federal Drug Administration (FDA) for these three vaccines. In August 2021, the `r manu_labels[["PFR"]]` COVID-19 vaccine received FDA approval for the prevention of COVID-19 disease for individuals 16 years and older. @pfrApproval Over 380 million doses of these vaccines have been administrated in the United States. 


Since the start of the vaccination process, the effectiveness of the COVID-19 vaccines has been estimated in several observational studies. 
A population-based study performed early during the vaccination process in Israel estimated the `r manu_labels[["PFR"]]` vaccine effectiveness against infection to be 66-85% and over 90% against COVID-19 hospitalization. @effIs
A matched cohort study, also in Israel, found 92% effectiveness against SARS-CoV-2 infection, 87% effectiveness for hospitalizations, and 72% effectiveness at preventing COVID-19 death for the `r manu_labels[["PFR"]]` vaccine. @effPFR 
A study conducted in inpatient care settings, across 187 hospitals in the United States,  found that the `r manu_labels[["MOD"]]`, `r manu_labels[["PFR"]]`, and `r manu_labels[["JSN"]]` COVID-19 vaccines were highly effective against COVID-19 related hospitalization, ICU admission, and emergency department or urgent care clinic visit. 
@thompson2021effectiveness
Other observational studies have estimated vaccine effectiveness amid variants of concern. The effectiveness against SARS-CoV-2 infection in the dominance of the Delta (B.1.617.2) variant has been shown to remain at 88% for the `r manu_labels[["PFR"]]` COVID-19 vaccine. 
@effDelta 
Similarly, a population-based observational study found that two doses of the `r manu_labels[["MOD"]]` and `r manu_labels[["PFR"]]` COVID-19 vaccines provided substantial protection against the Alpha (B.1.1.7), Beta (B.1.351), Gamma (P.1), and Delta variants of concern. @effVOCs  Nonetheless, real-world estimates comparing the 
`r manu_labels[["MOD"]]`, `r manu_labels[["PFR"]]`, and `r manu_labels[["JSN"]]` COVID-19 vaccines effectiveness against SARS-CoV-2 infections, COVID-19 hospitalizations and deaths, that consider time since initial inoculation, on the same population, is still limited.
Here we add to these findings by examining the effect of vaccines on all laboratory-confirmed SARS-CoV-2 infections observed in Puerto Rico since the vaccination process started, which provided enough power to estimate effectiveness across age groups and as a function of time since the individuals are considered fully vaccinated (two weeks after final dose).

Following the emergency approval of the `r manu_labels[["PFR"]]` vaccine manufactured by Pfizer-BioNTech on 
December 11, 2020, vaccine administration began in Puerto Rico on December 15, 2020. The logistics of the vaccination process proposed by the Puerto Rico Department of Health established that the vaccine administration would be completed in phases, as 
recommended by the World Health Organization (WHO) and the Centers for Disease Control and Prevention (CDC). @vax_plan The phases (appendix table \@ref(tab:tab-1)) consisted of vaccinating populations that were at greater risk of infection and severe disease. Front line health care workers and people 65 years and older were vaccinated in the first phase of the vaccination rollout.

By `r format(last_day, "%B %e, %Y")` more than 2 million of the `r make_pretty(pr_pop)` individuals living in Puerto Rico had completed the COVID-19 vaccination series. Furthermore, since the start of the vaccination process to `r format(last_day, "%B %e, %Y")`,  Puerto Rico experienced two SARS-CoV-2 infections surges, one starting in late March after restrictions were lifted and another in late June with the arrival of the Delta variant.  For this period, `r make_pretty(nrow(dat_cases_vax))` SARS-CoV-2 infections have been detected. We leveraged data collected by the Puerto Rico Department of Health to study the effect of the vaccination process in preventing SARS-CoV-2 outcomes by comparing unvaccinated individuals 12 years or older to those who had completed the vaccination series (two weeks after final dose) for `r manu_labels[["MOD"]]`, `r manu_labels[["PFR"]]`, or `r manu_labels[["JSN"]]` COVID-19 vaccines. We provide estimates of the effectiveness of the three COVID-19 vaccines protecting against SARS-CoV-2 infections, COVID-19 hospitalizations, and deaths to quantify the public health impact of the vaccine in Puerto Rico.

# Methods 


## Statistical analyses

Here we describe the approach used to estimate vaccine effectiveness as a function of time since becoming fully vaccinated. Note that this is different from estimating effectiveness as a function of calendar date since the date individuals became fully vaccinated vary from January to October. Because the vaccination process started at different dates for the different age groups and Puerto Rico had two SARS-CoV-2 infections surges during the study period, we had to develop a  statistical analysis that accounted for time-varying incidence rates and age. Below we provide a general description, with the mathematical details in the appendix. 

### Estimating time-varying effectiveness

We denoted an individual as fully vaccinated two weeks after the date they received the final dose in the COVID-19 vaccine series. SARS-CoV-2 infections in which the laboratory confirmation occurred after the first dose but before being fully vaccinated were removed from the analysis. For SARS-CoV-2 infections in which the laboratory confirmation occurred after being fully vaccinated, we recorded the number of days the individual had been fully vaccinated on the date their positive test was recorded. We denoted this value with $d$. Then for each date $t$ and each demographic stratum (defined by age group and gender) we computed the number of laboratory-confirmed SARS-CoV-2 infections among those that had been vaccinated for $d$ days. We denoted these counts with $Y_{t,d}$. To compute rates, we calculated, for each date $t$, the number of individuals in this stratum that became fully vaccinated $d$ days before a date $t$. We denoted this population size with $N_{t,d}$. 

To estimate the time varying relative risk as a function $d$, denoted with $RR(d)$, we assumed that the counts $Y_{t,d}$ followed a Poisson distribution with rate $N_{t,d} \times \mu_{t} \times RR(d)$, with $\mu_t$ the rate for the unvaccinated on date $t$, and $RR(d)$ a smooth function of $d$. Note that $1-RR(d)$ is equivalent to vaccine effectiveness.

To estimate $\mu_{t}$ we computed the number of laboratory-confirmed SARS-CoV-2 infections among the unvaccinated in the same demographic group, and, to compute rates, we calculated, for each date $t$, the number of individuals in the stratum that were unvaccinated and had not been infected within the last three months. With this estimate in place, we can use a generalized linear model to estimate $RR(d)$, and point-wise confidence intervals for each vaccine manufacturer, using data from all strata. Details are included in the appendix.

Note that this model can be fit to any demographic strata and any vaccine manufacturer to obtain time-varying vaccine effectiveness in these contexts. Furthermore, the approach can be applied to COVID-19 hospitalization or deaths by simply redefining  $Y_{t,d}$ with these outcomes rather than laboratory-confirmed SARS-CoV-2 infections. 


### Estimating time-varying risk of hospitalization and death conditioned on a laboratory-confirmed SARS-CoV-2 infection 

Note: in this section, to avoid introducing more mathematical symbols, we re-purpose the $Y$ and $N$ notation. 

To estimate the further protection provided by the vaccine in reducing adverse outcomes (COVID-19 hospitalizations or deaths) among infected individuals we examined the proportion of SARS-CoV-2 infections that had COVID-19 hospitalizations or deaths. Specifically, for each date $t$ and each demographic stratum we computed the number of laboratory-confirmed SARS-CoV-2 infections with an adverse outcome (COVID-19 hospitalization or death) among those that had been vaccinated for $d$ day. We denoted these counts with $Y_{t,d}$. Note that now, instead of obtaining the population from all vaccinated individuals to compute rates, we only considered individuals with laboratory-confirmed SARS-CoV-2 infections. Therefore, for each date $t$, we defined $N_{t,d}$ as the number of individuals in this stratum with laboratory-confirmed SARS-CoV-2 infections among those that had been vaccinated for $d$ day. We then assumed that $Y_{t,d}$ followed a binomial distribution with $N_{t,d}$ trials and success probability $p(d)$ assumed to be a smooth function of $d$. The probability $p(d)$ represents the time-varying risk of the adverse outcome conditional on infection. We compared this function to the conditional risk of unvaccinated individuals for each demographic group computed as the proportion of laboratory-confirmed unvaccinated individuals having adverse outcomes.

Note that this model can be fit to any demographic stratum and any vaccine manufacturer to obtain time-varying risks in these contexts. 

**Funding** NIH Grant R35GM131802 funded the work do RAI developing these statistical methods.

# Results

## Vaccination data

As of `r format(analysis_last_day, "%B %e, %Y")`, `r make_pretty(sum(vax_tots))` of the `r make_pretty(pr_pop)` individuals living in Puerto Rico had been fully vaccinated: `r make_pretty(vax_tots["PFR"])` with `r manu_labels[["PFR"]]`, `r make_pretty(vax_tots["MOD"])` with `r manu_labels[["MOD"]]`, and `r make_pretty(vax_tots["JSN"])` with `r manu_labels[["JSN"]]`. The daily COVID-19 vaccination rates were high during the first four months of the vaccination process, successfully vaccinating 50% of the eligible population (1,442,459 of 2,848,293) with at least one dose of a COVID-19 vaccine. @CIFRAS However, daily vaccination rates decreased after reaching 50%. The decrease in daily rate was particularly noticeable among the older age groups. After several vaccine mandates were implemented in July and August, the rate commenced increasing again (figure \@ref(fig:vax)) and by October 17, 2020, over 70% of the population was vaccinated, more than in any US state. With the exception of pediatric population (12-17 year old children) who were only vaccinated with `r manu_labels[["PFR"]]`, the age distribution of the vaccine was similar for all vaccine manufacturers (appendix figure \@ref(fig:vax-age)). However, the age distribution of the vaccinated population was different before and after Delta became dominant (appendix table \@ref(tab:vax-before-after-delta)).

## Observed SARS-CoV-2 infections, COVID-19 hospitalizations, and deaths 

During the period considered in this analysis (`r format(first_day, "%B %e, %Y")` to `r format(analysis_last_day, "%B %e, %Y")`),  `r make_pretty(sum(counts_cases$cases))` laboratory-confirmed SARS-CoV-2 infections were observed for individuals 12 years or older. These were mostly distributed across two surges (figure \@ref(fig:cases-hosp-deaths)). The first surge started shortly after several restrictions were lifted on March 15, 2021. Restrictions were imposed again on April 9, 2021, and the cases decreased to a level not seen since the summer of 2020. As a result, restrictions were lifted once again on May 24, 2021, and shortly after the arrival of the Delta variant, a second surge began by the end of June 2021. @ucc
The SARS-CoV-2 infections observed during the period of December 15, 2020 to `r format(last_day, "%B %d, %Y")` resulted in at least `r make_pretty(sum(counts_cases$hosp))` and `r make_pretty(sum(counts_cases$deaths))` COVID-19 hospitalizations and deaths, respectively (figure \@ref(fig:cases-hosp-deaths); appendix table \@ref(tab:overall)).

The laboratory-confirmed SARS-CoV-2 infections, COVID-19 hospitalization, and COVID-19 death rates were noticeably lower among the fully vaccinated (appendix table \@ref(tab:overall)). The protection afforded by the vaccine was observed by simply plotting the rates by vaccination group (figure \@ref(fig:cases-hosp-deaths)). The relative risk for the vaccinated seemed to increase after `r format(delta_date, "%B %e, %Y")`, the period in which the Delta variant dominated. However, these rates are not adjusted for age nor is potential waning effectiveness considered. Therefore, to better assess COVID-19 vaccine effectiveness, we applied the approach described in the Method Section. 

## Time-varying vaccine effectiveness against laboratory-confirmed SARS-CoV-2 infections 

We fit a statistical model to estimate time-varying vaccine effectiveness while accounting for the difference in demographics between vaccinated and unvaccinated individuals.  To evaluate whether the Delta variant affected vaccine effectiveness, we considered two periods: before and after `r format(delta_date, "%B %e, %Y")`. For this particular analysis, to ensure we had enough data in each stratum in both time periods (see appendix figure \@ref(fig:waning-population)), we considered a range of 0 to 90 days since fully vaccinated, combined the individuals over 65 into one age group, and excluded `r manu_labels[["JSN"]]` from the analysis. Although the Delta variant led to more SARS-CoV-2 infections (figure \@ref(fig:cases-hosp-deaths)A), a decrease in vaccine effectiveness was not detected, consistent with this variant being more contagious yet the vaccines equally effective against it. Note also that we did not find statistically significant differences among the age groups.

Considering that no clear differences were observed across age groups and time periods, we estimated one time-varying effectiveness across all age groups and for the entire vaccination process period. Because the period of evaluation was different for the different age groups, due to the previously described vaccine rollout phases (appendix table \@ref(tab:tab-1)), we included length of time since vaccination that was possible for the entire population: 
`r filter(the_max_day, manu=="MOD")$max.day` for `r manu_labels[["MOD"]]`,
`r filter(the_max_day, manu=="PFR")$max.day` for `r manu_labels[["PFR"]]`, and
`r filter(the_max_day, manu=="JSN")$max.day` for `r manu_labels[["JSN"]]`. We also excluded 12-17 year old individuals from this analysis since they were only vaccinated with `r manu_labels[["PFR"]]`.

The `r manu_labels[["MOD"]]`, `r manu_labels[["PFR"]]`, and `r manu_labels[["JSN"]]` started out with vaccines effectiveness  of 
`r wa_eff$MOD$max` (95% CI: `r wa_eff$MOD$max.lo`-`r wa_eff$MOD$max.up`), 
`r wa_eff$PFR$max` (`r wa_eff$PFR$max.lo`-`r wa_eff$PFR$max.up`), 
and 
`r wa_eff$JSN$max` (`r wa_eff$JSN$max.lo`-`r wa_eff$JSN$max.up`), 
respectively. Effectiveness then started waning to  `r wa_eff$MOD$min` (`r wa_eff$MOD$min.lo`-`r wa_eff$MOD$min.up`), `r wa_eff$PFR$min` (`r wa_eff$PFR$min.lo`-`r wa_eff$PFR$min.up`), and ,`r wa_eff$JSN$min` (`r wa_eff$JSN$min.lo`-`r wa_eff$JSN$min.up`) 
respectively, at the end of the study period (figure \@ref(fig:waning)B;  table \@ref(tab:waning-tab)).

Note: vaccine administration for individuals between 12 and 17 years started on May 12, 2021, and only with the `r manu_labels[["PFR"]]` vaccine.

## Time-varying vaccine effectiveness against COVID-19 hospitalizations and deaths 

We fit the same model to estimate relative risk of COVID-19 hospitalization and deaths. For hospitalizations we saw even higher effectiveness for `r manu_labels[["MOD"]]`, `r manu_labels[["PFR"]]`, and `r manu_labels[["JSN"]]` started out with vaccines effectiveness  of 
`r wa_eff_hosp$MOD$max` (95% CI: `r wa_eff_hosp$MOD$max.lo`-`r wa_eff_hosp$MOD$max.up`), 
`r wa_eff_hosp$PFR$max` (`r wa_eff_hosp$PFR$max.lo`-`r wa_eff_hosp$PFR$max.up`), 
and 
`r wa_eff_hosp$JSN$max` (`r wa_eff_hosp$JSN$max.lo`-`r wa_eff_hosp$JSN$max.up`), 
respectively. Effectiveness then started waning to  `r wa_eff_hosp$MOD$min` (`r wa_eff_hosp$MOD$min.lo`-`r wa_eff_hosp$MOD$min.up`), `r wa_eff_hosp$PFR$min` (`r wa_eff_hosp$PFR$min.lo`-`r wa_eff_hosp$PFR$min.up`), and `r wa_eff_hosp$JSN$min` (`r wa_eff_hosp$JSN$min.lo`-`r wa_eff$JSN$min.up`), respectively, after `r one_max_day` days. 
For deaths we saw even higher effectiveness: `r manu_labels[["MOD"]]`, `r manu_labels[["PFR"]]`, and `r manu_labels[["JSN"]]` started out with vaccines effectiveness  of 
`r wa_eff_deaths$MOD$max` (95% CI: `r wa_eff_deaths$MOD$max.lo`-`r wa_eff_deaths$MOD$max.up`), 
`r wa_eff_deaths$PFR$max` (`r wa_eff_deaths$PFR$max.lo`-`r wa_eff_deaths$PFR$max.up`), 
and 
`r wa_eff_deaths$JSN$max` (`r wa_eff_deaths$JSN$max.lo`-`r wa_eff_deaths$JSN$max.up`), 
respectively (figure \@ref(fig:waning)). Effectiveness then commenced waning to  `r wa_eff_deaths$MOD$min` (`r wa_eff_deaths$MOD$min.lo`-`r wa_eff_deaths$MOD$min.up`), 
`r wa_eff_deaths$PFR$min` (`r wa_eff_deaths$PFR$min.lo`-`r wa_eff_deaths$PFR$min.up`), and 
`r wa_eff_deaths$JSN$min` (`r wa_eff_deaths$JSN$min.lo`-`r wa_eff$JSN$min.up`), (figure \@ref(fig:waning)C,D; table \@ref(tab:waning-tab)).


## Vaccines lower the risk of COVID-19 hospitalization and death 

We fit a statistical model to determine if the vaccines provided further protection against COVID-19 hospitalization and death among SARS-CoV-2 infected individuals. Specifically, we estimated the age-group-specific risk of COVID-19 hospitalization and death conditioned on individuals testing positive for SARS-CoV-2 as a function of time since becoming fully vaccinated. Due to low sample sizes we did not run the analysis for `r manu_labels[["JSN"]]`, and for deaths, we combined the `r manu_labels[["MOD"]]` and `r manu_labels[["PFR"]]`data and only considered age groups above 65 years. We did not find clear evidence of waning for these conditional risks (see appendix figures \@ref(fig:waning-cond-hosp) and \@ref(fig:waning-cond-deaths)). We therefore, fit a version of the model with constant conditional risk for each age group, which provided enough statistical power to obtain an estimate for all age groups and vaccine manufacturers. The probability for COVID-19 hospitalization after SARS-CoV-2 infection for those that were vaccinated was at least twice lower for all age groups except the 85 and older for which the probability was over 1.5 times lower. Similarly, the probability of COVID-19 death after SARS-CoV-2 infection was over three times lower for all age groups, except the 85 and older for whom it was about twice as low (figure \@ref(fig:hosp-cond-cases); appendix table \@ref(tab:hosp-cond-cases-tab)). We did not find statistically significant evidence that the `r manu_labels[["JSN"]]` vaccine provided added protection against COVID-19 hospitalization for people 75 and older, but the sample size was small (appendix table \@ref(tab:hosp-cond-cases-tab)).

## COVID-19 hospitalizations and deaths avoided 

We calculated, for each age group, the expected number of COVID-19 hospitalizations and deaths that would have been observed had the rates in each vaccinated group been equal to the rates of the unvaccinated group. We computed this for each vaccine manufacturer (appendix figure \@ref(fig:exp-obs)). In total, for `r manu_labels[["MOD"]]`, `r manu_labels[["PFR"]]`, and `r manu_labels[["JSN"]]`, we saw a difference in COVID-19 hospitalizations between what was expected with the unvaccinated rates and what was observed of 
`r exp_obs %>% filter(manu=="MOD") %>% summarize(n=sum(exp_hosp)-sum(hosp)) %>% pull(n) %>% round %>% make_pretty`,
`r exp_obs %>% filter(manu=="PFR") %>% summarize(n=sum(exp_hosp)-sum(hosp)) %>% pull(n) %>% round %>% make_pretty`, and
`r exp_obs %>% filter(manu=="JSN") %>% summarize(n=sum(exp_hosp)-sum(hosp)) %>% pull(n) %>% round %>% make_pretty`, respectively. For deaths it was 
`r exp_obs %>% filter(manu=="MOD") %>% summarize(n=sum(exp_deaths)-sum(deaths)) %>% pull(n) %>% round %>% make_pretty`,
`r exp_obs %>% filter(manu=="PFR") %>% summarize(n=sum(exp_deaths)-sum(deaths)) %>% pull(n) %>% round %>% make_pretty`, and
`r exp_obs %>% filter(manu=="JSN") %>% summarize(n=sum(exp_deaths)-sum(deaths)) %>% pull(n) %>% round %>% make_pretty`. 
The grand total was at least
`r exp_obs %>% summarize(n=sum(exp_hosp)-sum(hosp)) %>% pull(n) %>% round %>% make_pretty`,  COVID-19 hospitalizations and 
`r exp_obs %>% summarize(n=sum(exp_deaths)-sum(deaths)) %>% pull(n) %>% round %>% make_pretty`,  COVID-19 deaths avoided.

## No evidence of confounding

We examined vaccine effectiveness during the days right after the first dose. If the vaccinated and unvaxinated groups are comparable, apart from the vaccine effect, we expect to see no difference in infection rates (effectiveness = 0), since during the first days, the vaccine has not yet taken effect. The data are consistent with the two groups being comparable in terms of risk behaviors (appendix figure  \@ref(fig:confounder-check)). Note that we observed effectiveness estimates near 1, instead of 0, right after the first was administered. Note that this is expected because SARS-CoV-2 infected individuals were discouraged from getting vaccine until they recovered. This implies that on the day of the first dose we should see effectiveness close to 1. As the days go by, effectiveness drop to around 0 as expected, before it starts increasing consistent with the individuals starting to acquire immunity. 

# Discussion 

Our analyses demonstrate that all vaccines were effective at reducing risks of SARS-CoV-2 infection, COVID-19 hospitalization and deaths across all age groups. This was evident in mid July when 
a preliminary analysis of these data @prelim led the government to impose a series of vaccine mandates between July 22 and August 19, 2021. Daily vaccination rates increased after this and by September 27, 2021, Puerto Rico passed Massachusetts, Vermont, Maine, and Connecticut to become the US jurisdiction with the highest vaccination rate. The results of this analysis are currently being used to develop recommendations regarding boosters shots. For example, we found that the protection provided by the `r manu_labels[["MOD"]]` and `r manu_labels[["PFR"]]` vaccines were stronger and longer lasting than `r manu_labels[["JSN"]]`  and, as a result, the Puerto Rico Department of Health is recommending `r manu_labels[["MOD"]]` and `r manu_labels[["PFR"]]` boosters for individuals that received their  `r manu_labels[["JSN"]]` over two months ago. We also found that the effectiveness of all vaccines decreased over time, implying that to reach herd immunity, boosters shots will be needed. These results also 
raise the question of weather new vaccines mandates should require booster shots after a certain time period of receiving the final dose. 

It is important to note that this an observational study and not a randomized clinical trial. Although we controlled for confounding factors that were coded and available for analyses, it is possible that there were unknown and unobserved confounders that were not accounted for, such as chronic health conditions and immunocompromising conditions. However, the findings described here agree with general trends observed in the clinical trials and our analysis exploring for effects due to confounding did not reveal concerning results. [@CTPFR] [@CTMOD] [@CTJanssen]

It is also important to note that the statistical analysis presented here is completely reproducible. Furthermore, the Puerto Rico Department of Health has developed a reproducible pipeline that can update the dataset needed to perform the analysis. We can therefore update the results regularly to continue providing guidance on public health decisions in Puerto Rico, and beyond.

# Contributors

RAI conceived this study. ICG was the project administrator of the vaccination process in Puerto Rico. EGN coordinated and managed the Department of Health databases. EGN and MMRF curated the data under RAI's supervision. MMRF and RAI performed the statistical analysis and wrote the first draft of the manuscript. All authors gave feedback on the  manuscript for important intellectual content. All authors gave final approval of the version to be published. All authors had final responsibility for the decision to submit for publication.

# Declaration of interests

The authors declare no conflict of interests.

# Data sharing

The data and code needed to reproduce this analysis is here: https://github.com/rafalab/vax-eff-pr. The data wrangling code for curation is also available. The raw data sits on Department of Health HIPAA compliant databases and is not publicly available as it includes personal identifiers. 

# Acknowledgements  

We thank the Puerto Rico Department of Health and Digheontech, Inc. for allowing us to collaborate in this effort. In particular, we thank doctors Carlos Mellado, Melissa Marzán, and Daniel Colón-Ramos for their continued support and suggestions in the completion of this project. Furthermore, we thank Wilmarí de Jesús Álvarez and Dr. Fabiola Cruz López for providing insight into aspects concerning demography and molecular epidemiology, respectively. 

# References 

<div id="refs"></div>

\pagebreak

# Figures 


```{r vax, fig.cap="Total number of fully vaccinated individuals per day by vaccine manufacturer (represented with different colors).", fig.width = 6, fig.height = 4, out.width="60%"}
counts_vax_age_gender_manu %>%
  group_by(date, manu) %>%
  summarize(vax=sum(vax), .groups = "drop") %>%
  ggplot(aes(date,vax, color = manu))+
  geom_line(lwd = 1.5) +
  scale_color_manual(labels = c(manu_labels[["MOD"]], manu_labels[["PFR"]], manu_labels[["JSN"]]),
                     values = c(manu_colors[["MOD"]], manu_colors[["PFR"]], manu_colors[["JSN"]]), name = "Vaccine")+
  scale_y_continuous(labels=scales::comma)+
  scale_x_date(breaks="1 month", date_labels = "%b")+
  labs(y="Fully vaccinated individuals", x="Date", fill = "")+
  theme_bw() + theme(legend.position = "bottom")
```


\pagebreak

```{r cases-hosp-deaths, fig.cap="Above: SARS-CoV-2 infections (Cases), COVID-19 hospitalizations and deaths per day for individuals 12 years or older during the period of study. Below: Weekly rates (per day per 100,000) for SARS-CoV-2 infections (Cases), COVID-19 hospitalizations and deaths by vaccination status. The rates are based on total numbers and are not adjusted for age. Colors are used to denote the different vaccination status.", fig.width = 8, fig.height = 6}
deaths <- dat_cases %>%
  filter(status != "PAR") %>%
  filter(!is.na(ageRange)) %>%
  filter(death) %>%
  mutate(date_death = 
           if_else(is.na(date_death) | date_death<first_day | date_death>last_day, date, date_death)) %>%
  group_by(date_death) %>%
  summarize(deaths = n()) %>%
  rename(date = date_death) 

hosp <- dat_cases %>%
  filter(status != "PAR") %>%
  mutate(date_hosp = 
           if_else(date_hosp<first_day | date_hosp>last_day, date, date_death)) %>%
  filter(!is.na(date_hosp)) %>%
  group_by(date_hosp) %>%
  summarize(hosp = n()) %>%
  rename(date = date_hosp)%>%
  filter(date>=first_day)

cases <- dat_cases %>%
  filter(status != "PAR") %>%
  filter(date >= first_day &  date<= analysis_last_day) %>%
  group_by(date) %>%
  summarize(cases = n()) 

p1 <- cases %>%
  full_join(deaths, by = "date") %>%
  full_join(hosp, by = "date") %>%
  replace_na(list(hosp = 0, deaths = 0)) %>%
  setNames(c("Date", "Cases", "Hospitalizations", "Deaths")) %>%
  pivot_longer(-Date) %>%
  mutate(name = factor(name, levels = c("Cases", "Hospitalizations", "Deaths"))) %>%
  ggplot(aes(Date, value)) +
  geom_bar(stat = "identity") +
  facet_wrap(~name, ncol = 3, scale = "free_y") +
  labs(y="Daily counts")+
  scale_x_date(breaks="2 month", date_labels = "%b")+
  theme_bw() #+

p2 <- counts_cases %>% 
  filter(date >= ceiling_date(min(date), unit = "week", week_start = wday(last_day)) & date <= last_day - weeks(1)) %>%
  mutate(week = floor_date(date, unit = "week", week_start = wday(last_day))) %>% 
  group_by(manu, week) %>%
  summarize( 
    Cases = sum(cases) / sum(poblacion) * 10^5,
    Hospitalization = sum(hosp) / sum(poblacion) * 10^5,
    Deaths = sum(deaths) /sum(poblacion) * 10^5,
    .groups = "drop") %>% 
  pivot_longer(c(Cases, Hospitalization, Deaths)) %>%
  mutate(name = factor(name, levels = c("Cases", "Hospitalization", "Deaths"))) %>%
  ggplot(aes(week, value, color = manu)) +
  geom_line() + 
  labs(y="Rates (per day per 100,000)", x="Date")+
  scale_x_date(breaks="2 month", date_labels = "%b")+
  scale_color_manual(
    labels = c(manu_labels[["UNV"]], manu_labels[["MOD"]], manu_labels[["PFR"]], manu_labels[["JSN"]]),
    values = c(manu_colors[["UNV"]], manu_colors[["MOD"]], manu_colors[["PFR"]], manu_colors[["JSN"]]), name="Vaccination status") +
  geom_point(show.legend = FALSE, size=0.75) +
  facet_wrap(~name, scales = "free_y", ncol = 3) +
  theme_bw()+
  theme(legend.position = "bottom")

gridExtra::grid.arrange(p1, p2, ncol = 1)
```


\pagebreak

```{r , fig.width=8, fig.height=4, out.width="100%"}
waning_dat  %>% 
  mutate(ageRange = fct_collapse(ageRange, "65+"=c("65-74", "75-84", "85+")))%>%
  filter(!(ageRange == "12-17" & manu == "MOD") & manu != "JSN" & day <= 90) %>%
  mutate(max.day = 90) %>%
  group_by(delta, ageRange, manu) %>%
  do(fit_waning_model(., knots = c(45), alpha = 0.05)) %>%
  ggplot(aes(day, fit, color=delta)) + 
  geom_line(size = 0.75) + 
  geom_ribbon(aes(ymin=conf.low, ymax = conf.high, fill = delta), 
              alpha = 0.5, color = NA,  show.legend = FALSE) +
  facet_grid(manu~ageRange, labeller = labeller(manu = as_labeller(c(`MOD` = manu_labels[["MOD"]], `PFR` = manu_labels[["PFR"]])))) +  
  coord_cartesian(ylim=c(0,1)) +
  scale_y_continuous(labels = scales::percent) + 
  labs(x="Days since fully vaccinated", y="Vaccine effectiveness")+
  scale_color_manual(labels = c(manu_labels[["before"]], manu_labels[["after"]]), 
                     values = c(manu_colors[["before"]], manu_colors[["after"]]),  name = "")+
  scale_fill_manual(labels = c(manu_labels[["before"]], manu_labels[["after"]]), 
                    values = c(manu_colors[["before"]], manu_colors[["after"]]),  name = "") +
  theme_bw() + theme(legend.position = "bottom") +
  ggtitle("A")
```

```{r waning, fig.cap="Estimated effectiveness plotted against days since the individuals were fully vaccinated. The ribbons represent point-wise 99\\% confidence intervals. A) Comparison before and after the Delta variant became dominant by age group and and vaccine manufacturer (mRNA-1273 and BNT162b2).  B) Vaccine effectiveness against infections by manufacturer for the entire study period and age groups combined. C) As B) but for hospitalizations D) As B) but for deatsh. ", fig.width=8, fig.height=3, out.width="100%"}
bind_rows(mutate(waning_fit, event="B"),
          mutate(waning_hosp_fit, event = "C"),
          mutate(waning_deaths_fit, event = "D")) %>%
    ggplot(aes(day, fit, color=manu)) + 
    geom_ribbon(aes(ymin=conf.low, ymax = conf.high, fill = manu), 
                alpha = 0.5, color = NA, show.legend = FALSE) +
    geom_line() + 
    scale_y_continuous(labels = percent)  +
    geom_hline(yintercept = 0, lty = 2) +
    coord_cartesian(ylim=c(0,1)) + 
    theme_bw() +
    scale_color_manual(labels = c(manu_labels[["MOD"]], manu_labels[["PFR"]], manu_labels[["JSN"]]),
                       values = c(manu_colors[["MOD"]], manu_colors[["PFR"]], manu_colors[["JSN"]]), name = "Vaccine")+
    scale_fill_manual(labels = c(manu_labels[["MOD"]], manu_labels[["PFR"]], manu_labels[["JSN"]]),
                      values = c(manu_colors[["MOD"]], manu_colors[["PFR"]], manu_colors[["JSN"]]), name = "Vaccine") + 
    labs(x = "Days since fully vaccinated", y = "Vaccine effectiveness")+
    theme_bw()+
    theme(legend.position = "bottom") +
    facet_wrap(~event) + 
  theme(strip.background = element_blank(), 
        strip.text = element_text(hjust = 0, size = 12))
```

\pagebreak

```{r, fig.width=8, fig.height=3.5}
p1 <- hosp_by_cases %>%
  filter(!(ageRange %in% c("75-84", "85+") & group == "JSN")) %>%
  ggplot(aes(ageRange, rate, ymin = conf.low, ymax = conf.high, color = group)) +
  labs(color = "") +
  geom_errorbar(position = position_dodge(.3), width = 0.25) + 
  geom_point(position = position_dodge(.3), size=1) +
  xlab("Age group") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0), legend.position = "none") +
  scale_y_continuous(labels = scales::percent) +
  scale_color_manual(labels = c(manu_labels[["UNV"]], manu_labels[["MOD"]],
                                manu_labels[["PFR"]], manu_labels[["JSN"]]),
                     values = c(manu_colors[["UNV"]], manu_colors[["MOD"]],
                                manu_colors[["PFR"]], manu_colors[["JSN"]])) +
  ylab("Probability of hospitalization among infected") +
  ggtitle("A") + theme(title=element_text(size=10)) +
  coord_cartesian(ylim=c(0,.325))
p1

```

```{r hosp-cond-cases, fig.width=8, fig.height=3.5, fig.cap="Estimated probability of adverse outcomes from COVID-19 among individuals infected with SARS-CoV-2 with 95\\% confidence intervals. Two vaccinated groups are compared to unvaccinated with the different vaccination manufacturers denoted with color. For Ad26.COV2.S, the estimates and confidence intervals for the 75-84 and 85+ are not shown due to small sizes. A) Hospitalizations. B) Deaths "}


p2 <- deaths_by_cases %>%
  filter(!(ageRange %in% c("75-84", "85+") & group == "JSN")) %>%
  ggplot(aes(ageRange, rate, ymin = conf.low, ymax = conf.high, color = group)) +
  labs(color = "") +
  geom_errorbar(position = position_dodge(.3), width = 0.25, show.legend = T) + 
  geom_point(position = position_dodge(.3), size = 1, show.legend = T) +
  xlab("Age group") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0), legend.position = "bottom") +
  scale_y_continuous(labels = scales::percent) + 
  scale_color_manual(labels = c(manu_labels[["UNV"]], manu_labels[["MOD"]],
                                manu_labels[["PFR"]], manu_labels[["JSN"]]),
                     values = c(manu_colors[["UNV"]], manu_colors[["MOD"]],
                                manu_colors[["PFR"]], manu_colors[["JSN"]])) +
  ylab("Probability of death among infected") +
  ggtitle("B")+ theme(title=element_text(size=10))+
  coord_cartesian(ylim=c(0,.325))



p2
```

\pagebreak

# Tables 

```{r waning-tab} 
d <- bind_rows(
  mutate(waning_tab, Outcome = "Infection"),
  mutate(waning_hosp_tab, Outcome = "Hospitalization"),
  mutate(waning_deaths_tab, Outcome = "Death")) %>%
  relocate(Outcome) %>%
  mutate("Vaccine" = recode(manu, PFR = manu_labels[["PFR"]], 
                            MOD = manu_labels[["MOD"]], 
                            JSN = manu_labels[["JSN"]]),
         "Effectiveness on first day as fully vaccinated (CI)" = paste0(make_pct(max), 
                                            " (", make_pct(max.lo), " - ",
                                            make_pct(max.up), ")"),
         "Effectiveness at end of period (CI)" = paste0(make_pct(min), 
                                                        " (", make_pct(min.lo), " - ",
                                                        make_pct(min.up), ")")
  ) %>%
  dplyr::select(`Outcome`, `Vaccine`, `Effectiveness on first day as fully vaccinated (CI)`, 
                `Effectiveness at end of period (CI)`) %>%
  arrange(factor(Vaccine, levels=plot_manu_levels))

names(d)[4] <- paste("Effectiveness after", one_max_day, "days (CI),")

flextable(d) %>%
  set_caption("Waning effectiveness against infection with 99\\% point-wise confidence intervals.") %>%
  align(j=1:2, align = "left", part = "all") %>%
  align(j=3:4, align = "center", part = "all")  %>%
  width(j=1:2, 1.5) %>%
  width(j=c(3,4), 2) %>% fit_to_width(max_width = 7)
```



\pagebreak

# Appendix


\renewcommand{\thefigure}{S\arabic{figure}}
\setcounter{figure}{0}
\renewcommand{\thetable}{S\arabic{table}}
\setcounter{table}{0}

## Supplementary Figures 

```{r vax-age, fig.cap="Total number of fully vaccinated individuals by age group and vaccine manufacturer. Each pane represents a vaccine manufacturer and colors represent the different age groups.", fig.width = 8, fig.height = 3}
vaccine_labeller <- c("JSN" = manu_labels[["JSN"]], 
                      "MOD" = manu_labels[["MOD"]],
                      "PFR" = manu_labels[["PFR"]])

breaks <- c(12, 18, seq(25, 85, 10))
counts_vax_age_gender_manu %>%
  mutate(ageRange = collapse_age_range(ageRange, breaks)) %>%
  filter(!is.na(ageRange)) %>%
  group_by(date, ageRange, manu) %>%
  summarize(vax=sum(vax), .groups = "drop") %>%
  ggplot(aes(date,vax,fill=ageRange))+
  geom_area() +
  facet_wrap(~manu, ncol = 3,  labeller = as_labeller(vaccine_labeller)) +
  theme_bw() +
  labs(y="Fully vaccinated individuals", x="Date", fill="Age group")+
  scale_y_continuous(labels=scales::comma) + 
  theme(legend.position = "bottom")
```

\pagebreak

```{r waning-population, fig.cap="Number of individuals for each possible value of days since fully vaccinated. We show values for before and after the Delta variant became dominant (solid versus dashed) and vaccine manufacturer (colors).", fig.width = 8, fig.height = 8, out.width = "100%"}
waning %>% group_by(delta, manu, ageRange, day) %>% 
  summarize(poblacion = sum(poblacion), .groups = "drop") %>% 
  filter(!(ageRange == "12-17" & manu != "PFR")) %>%
  mutate(delta = recode(delta, before = manu_labels[["before"]], after = manu_labels[["after"]])) %>%
  ggplot(aes(day, poblacion, color = manu, linetype = delta)) +
  geom_line() +
  ylab("Number of indivuals")+
  xlab("Days since fully vaccinated") +
  scale_y_continuous(labels = comma)+
  facet_wrap(~ageRange) +
  theme_bw() +
  scale_linetype(name = "") +
  scale_color_manual(labels = c(manu_labels[["MOD"]], manu_labels[["PFR"]], manu_labels[["JSN"]]),
                     values = c(manu_colors[["MOD"]], manu_colors[["PFR"]], manu_colors[["JSN"]]), name = "Vaccine")+ 
  theme(legend.position = "bottom")
```

\pagebreak


```{r waning-cond-hosp, width = 6, height = 6, out.width="100%", fig.cap = "Estimates for risk of COVID-19 hospitalization among individuals with laboratory-confirmed SARS-CoV-2 infections as a function of days since being fully vaccinated. The 99\\% point-wise estimates are included. Each pane shows a different age group and vaccine types are denoted by color. The BNT162b2 was not included due to small sample sizes."}
fit_glm <- function(tab, alpha = 0.01, transf = function(x){ 1/(1+exp(-x))}){
  tab <- filter(tab, day <= max.day)
  knots <- min(tab$max.day)/2
  fit <- glm(cbind(obs, poblacion-obs) ~ ns(day, knots= knots), 
             family = "binomial", data = tab)
  
  pred <- predict(fit, se.fit = TRUE)
  tab <- mutate(tab, fit = transf(pred$fit), 
                conf.low = transf(pred$fit + qnorm(1-alpha/2) * pred$se.fit),
                conf.high = transf(pred$fit - qnorm(1-alpha/2) * pred$se.fit))
}

hosp_fit <- waning_given_cases %>%  
  filter(ageRange != "12-17" & manu != "JSN") %>%
  group_by(manu, ageRange, day) %>%
  summarize(poblacion = sum(poblacion), 
            obs= sum(hosp), .groups = "drop") %>%
  left_join(max_days, by = c("manu", "ageRange")) %>%
  group_by(manu, ageRange) %>%
  do(fit_glm(.)) %>%
  ungroup()

hosp_fit %>%
  ggplot(aes(day, fit, ymin = conf.low, ymax = conf.high, color = manu, fill= manu)) +
  geom_ribbon(alpha = 0.25, color = NA) +    
  geom_line() +
  facet_wrap(~ageRange, nrow = 2) +
  scale_color_manual(labels = c(manu_labels[["MOD"]], manu_labels[["PFR"]], manu_labels[["JSN"]]),
                    values = c(manu_colors[["MOD"]], manu_colors[["PFR"]], manu_colors[["JSN"]]), name = "Vaccine")+
  scale_fill_manual(labels = c(manu_labels[["MOD"]], manu_labels[["PFR"]], manu_labels[["JSN"]]),
                    values = c(manu_colors[["MOD"]], manu_colors[["PFR"]], manu_colors[["JSN"]]), name = "Vaccine") +
  labs(x="Days since fully vaccinated", y="Risk of hospitalization \n given infection")+theme_bw()+theme(legend.position = "bottom")
```


```{r waning-cond-deaths, width = 6, height = 3.6, out.width="100%", fig.cap = "Estimates for risk of COVID-19 death among individuals with laboratory-confirmed SARS-CoV-2 infections as a function of days since being fully vaccinated. The 99\\% point-wise estimates are included. Each pane shows a different age group . The Ad26.COV2.S was not included due to small sample sizes.", out.width="75%"}
deaths_fit <- waning_given_cases %>%  
  filter(ageRange %in% c("65-74", "75-84", "85+"))  %>%
  left_join(max_days, ageRange, by = c("ageRange", "manu")) %>%
  group_by(ageRange, day) %>%
  summarize(poblacion = sum(poblacion), 
            obs= sum(deaths), max.day = min(max.day), 
            .groups = "drop") %>%
  group_by(ageRange) %>%
  do(fit_glm(.)) %>%
  ungroup()

deaths_fit %>% 
  ggplot(aes(day, fit, ymin = conf.low, ymax = conf.high)) +
  geom_ribbon(alpha = 0.25, color = NA, show.legend = FALSE) +    
  geom_line() +
  facet_wrap(~ageRange, nrow = 1) +
  coord_cartesian(ylim = c(0, 0.25))  +
  labs(x="Days since fully vaccinated", y="Risk of hospitalization given infection")+theme_bw()+theme(legend.position = "bottom")
```


```{r exp-obs, fig.cap = "Reduction in risk provided by the different vaccines for individuals across age groups. The graph shows estimated expected outcomes based on estimated unvaccinated rates and those observed. A) COVID-19 hospitalizations. B) COVID-19 deaths.", fig.height=8, fig.height=6, out.width="100%" }
p1 <- exp_obs %>% select(ageRange, manu, contains("hosp")) %>% 
  filter(manu != "UNV") %>%
  pivot_longer(cols = contains("hosp"), names_to = "status", values_to = "value") %>%
  mutate(status = recode(status, hosp = "Observed", exp_hosp = "Expected")) %>%
  ggplot(aes(ageRange, value, fill = status)) +
  geom_bar(stat = "identity", width=.5, position = "dodge")  +
  theme_bw() +
  facet_wrap(~manu, labeller = as_labeller(vaccine_labeller)) +
  ylab("COVID-19 hospitalizations") +
  xlab("Age Group") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.title = element_blank(), legend.position = "none")+
  ggtitle("A")
   

p2 <- exp_obs %>% select(ageRange, manu, contains("deaths")) %>% 
  filter(manu != "UNV") %>%
  pivot_longer(cols = contains("deaths"), names_to = "status", values_to = "value") %>%
  mutate(status = recode(status, deaths = "Observed", exp_deaths = "Expected")) %>%
  ggplot(aes(ageRange, value, fill = status)) +
  geom_bar(stat = "identity", width=.5, position = "dodge")  +
  theme_bw() +
  facet_wrap(~manu, labeller = as_labeller(vaccine_labeller)) +
  ylab("COVID-19 deaths") +
  xlab("Age Group") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.title = element_blank(), legend.position = "bottom") +
  ggtitle("B")

gridExtra::grid.arrange(p1,p2)
```


\pagebreak

```{r,  width = 8, height = 3, out.width="100%"}
cases_exp <- compute_expected(unvax, outcome = "cases") %>%
  mutate(rate = fit / poblacion) %>%
  select(date, ageRange, gender, rate)

partial_eff_dat <- partial_eff %>% 
  left_join(cases_exp, by = c("date", "ageRange", "gender")) %>%
  mutate(exp = rate * poblacion) %>% 
  group_by(delta, ageRange, manu, day) %>%
  summarize(obs = sum(cases), exp = sum(exp), .groups = "drop")

partial_eff_dat %>% 
  mutate(ageRange = fct_collapse(ageRange, "65+" = c("65-74","75-84", "85+")))%>%
  filter(manu != "JSN") %>%
  group_by(day, ageRange) %>%
  summarize(obs = sum(obs), exp = sum(exp), .groups = "drop") %>%
  mutate(ve = 1-obs/exp, 
         conf.low = 1-qpois(0.025, obs)/exp,
         conf.high = 1-qpois(0.975, obs)/exp) %>%
  ggplot(aes(day, ve, ymin = conf.low, ymax = conf.high)) + 
  geom_errorbar() +
  geom_point() +
  xlab("Days since fully vaccinated") +
  ylab("Vaccine effectiveness") +
  facet_wrap(~ageRange, ncol = 4) +
  geom_hline(yintercept = 0, lty = 2) + 
  theme_bw() +
  ggtitle("A")

```

```{r confounder-check, fig.cap = "We computed vaccine effectiveness, defined as 1 minus observed laboratory-confirmed SARS-CoV-2 infections divided by what is expected without vaccination, for each day since being fully vaccinated. A) Data for the mRNA-1273 and BNT162b2 were combined and results are shown for each age group. B) Data for Ad26.COV2.S with age groups combined to provide statistical power."}
partial_eff_dat %>% 
  filter(manu == "JSN" & ageRange != c("12-17")) %>%
  mutate(ageRange = fct_collapse(ageRange, 
                        "18-64" = age_levels[2:6],
                        "65+" = age_levels[7:9])) %>%
  mutate(day = ifelse(ageRange == "65+", floor(day/5)*5 +2.5, day)) %>%
  group_by(day, ageRange) %>%
  summarize(obs = sum(obs), exp = sum(exp), .groups = "drop") %>%
  mutate(ve = 1-obs/exp, 
         conf.low = 1-qpois(0.025, obs)/exp,
         conf.high = 1-qpois(0.975, obs)/exp) %>%
  ggplot(aes(day, ve, ymin = conf.low, ymax = conf.high))+
  geom_errorbar() +
  geom_point() +
  facet_wrap(~ageRange, ncol = 4) +
  coord_cartesian(ylim=c(-1,1)) + 
  geom_hline(yintercept = 0, lty = 2) + 
  xlab("Days since fully vaccinated") +
  ylab("Vaccine effectiveness") +
  theme_bw() +ggtitle("B")
```



\pagebreak

## Supplementary Tables 


```{r tab-1}
flextable(rollout) %>%
 set_caption("Chronology of the COVID-19 vaccine rollout in Puerto Rico.") %>%
  width(j=1, 0.85) %>%
  width(j=2, 6) %>%
 fontsize(size=8)


```

\pagebreak
```{r vax-before-after-delta}
bind_rows(mutate(daily_counts_onedose_age_gender_manu, status = "first"),
          mutate(daily_counts_vax_age_gender_manu, status = "full")) %>%
  mutate(manu = droplevels(manu)) %>%
  mutate(delta = factor(if_else(date < delta_date, "before", "after"), 
                        levels = c("before","after"))) %>%
  group_by( status, manu,delta, ageRange) %>%
  summarize(n = sum(vax), .groups = "drop")  %>% 
  mutate(n = ifelse(manu!="PFR" & ageRange == "12-17", "-", make_pretty(n)))%>%
  mutate(manu = recode(manu, MOD = manu_labels[["MOD"]], PFR = manu_labels[["PFR"]], JSN = manu_labels[["JSN"]]),
         delta = recode(delta, before = paste("before", format(delta_date, "%B %e")),
                        after = paste("after", format(delta_date, "%B %e"))),
                    status = recode(status, first = "First dose", full = "Fully vaccinated")) %>%
  mutate(delta = paste(status, delta))  %>%
  select(-status) %>%
  pivot_wider(names_from = "delta", values_from = n) %>%
  rename("Age group" = ageRange, Manufacturer = manu) %>%
  flextable() %>%
  set_caption(paste0("Number of individuals, by age group, receiving the first or dose or being fully vaccinated before and after ",
                     format(delta_date, "%B %e, %Y"), " when Delta variant becaome dominant in Puerto Rico.")) %>%
  align(j=1:3, align = "center", part = "all") %>%
  align(j=3:6, align = "right", part = "all") %>%
  width(j=1, 1) %>%
  width(j=2, .75) %>%
  width(j=3:6, 1) %>%
  fontsize(size = 10) 
```


\pagebreak
```{r overall}
tmptab <- data.frame(vax = c("Total",
                             "Unvaccinated",
                             manu_labels[["PFR"]],
                             manu_labels[["MOD"]], 
                             manu_labels[["JSN"]]),
                     pop = c(make_pretty(round(sum(vax_cases_tots$poblacion))),
                             make_pretty(round(filter(vax_cases_tots, manu == "UNV")$poblacion)),
                             make_pretty(round(filter(vax_cases_tots, manu == "PFR")$poblacion)), 
                             make_pretty(round(filter(vax_cases_tots, manu == "MOD")$poblacion)), 
                             make_pretty(round(filter(vax_cases_tots, manu == "JSN")$poblacion))),
                     cases = c(make_pretty(ncases),
                               make_pretty(filter(vax_cases_tots, manu == "UNV")$cases),
                               make_pretty(filter(vax_cases_tots, manu == "PFR")$cases), 
                               make_pretty(filter(vax_cases_tots, manu == "MOD")$cases), 
                               make_pretty(filter(vax_cases_tots, manu == "JSN")$cases)),
                     hosp = c(make_pretty(nhosp),
                              make_pretty(filter(vax_cases_tots, manu == "UNV")$hosp),
                              make_pretty(filter(vax_cases_tots, manu == "PFR")$hosp), 
                              make_pretty(filter(vax_cases_tots, manu == "MOD")$hosp), 
                              make_pretty(filter(vax_cases_tots, manu == "JSN")$hosp)),
                     deaths = c(make_pretty(ndeaths),
                                make_pretty(filter(vax_cases_tots, manu == "UNV")$deaths),
                                make_pretty(filter(vax_cases_tots, manu == "PFR")$deaths), 
                                make_pretty(filter(vax_cases_tots, manu == "MOD")$deaths), 
                                make_pretty(filter(vax_cases_tots, manu == "JSN")$deaths))
)

names(tmptab) <- c(" ",
                   "Person years",
                   "Cases",
                   "Hospitalizations",
                   "Deaths")

tmptab <- tmptab[c(1,2,4,3,5),]
flextable(tmptab) %>%
  set_caption(paste0("Person years, SARS-CoV-2 infections (cases), hospitalizations, and deaths from ", 
                     format(first_vax_day, "%B %e, %Y"), ", the first day that individuals were fully vaccinated, to ", 
                     format(last_day, "%B %e, %Y"), " by vaccination group.")) %>%
  align(j=1, align = "left", part = "all") %>%
  align(j=2:5, align = "right", part = "all") %>%
  width(j=1, 1.25) %>%
  width(j=2, 2) %>%
  width(j=3:5, 1) %>%
  fontsize(size = 10)  %>% fit_to_width(max_width = 7)
```

\pagebreak
```{r hosp-cond-cases-tab, fit.cap = "Estimated probability of hospitalizations and deaths from COVID-19 among individuals infected with SARS-CoV-2 with 95\\% confidence intervals."}
bind_rows(mutate(hosp_by_cases, Outcome = "Hospitalization"),
          mutate( deaths_by_cases, Outcome = "Deaths")) %>%
  relocate("Outcome") %>% 
  mutate(rate = paste0(format(round(rate,2), digits = 2, nsmall =2), 
                       " (", format(round(conf.low,2), digits = 2, nsmall =2), ",", 
                       format(round(conf.high,2), digits = 2, nsmall =2), ")")) %>%
  select(Outcome, ageRange, group, rate)  %>%
  mutate(group = recode(group, UNV="Unvaccinated", MOD = manu_labels[["MOD"]], PFR = manu_labels[["PFR"]], JSN = manu_labels[["JSN"]])) %>%
  pivot_wider(names_from=group, values_from = rate, values_fill = "-") %>%
  rename("Age group" = "ageRange") %>%
  flextable() %>%
  set_caption("Estimated probability of hospitalizations and deaths from COVID-19 among individuals infected with SARS-CoV-2. Note that the mRNA-1273 vaccine is not approved for individuals younger than 18. Thus no  probabilities are reported for the 12-17 age group for this vaccine.") %>%
  align(j=1:2, align = "left", part = "all") %>%
  align(j=3:5, align = "center", part = "all") %>%
  width(j=1, 1.25) %>%
  width(j=2, 0.9) %>%
  width(j=3:6, 1.25) %>%
  fontsize(size = 10) %>% fit_to_width(max_width = 7)
```

\pagebreak

## Supplementary Methods

### Data sources 

Two Puerto Rico Department of Health databases were integrated: the BioPortal, which stores laboratory SARS-CoV-2 test results, most COVID-19 hospitalizations, and COVID-19 deaths, and the Puerto Rico Electronic Immunization System (PREIS), which stores vaccination related data, including COVID-19 vaccination. The Department of Health used full names (including maternal last names), date of birth, and municipalities to match the two databases. Because over 200 billion records needed to be compared, an algorithm was developed to do this automatically. Using a smaller subset curated by a human, we determined the algorithm to provide matches that well over 99.99% accurate. 

The code for the matching algorithm is available at https://github.com/rafalab/vax-eff-pr. However, the data is not available as it contains personal identifiers.

### Statistical analyses

We applied models that accounted for age, gender, and, since many more tests were performed on weekdays than weekends, day of the week. We used the estimates obtained from fitting these models to quantify effectiveness against a SARS-CoV-2 infection and relative risks for COVID-19 hospitalizations and deaths. The models used for the different analyses are described below. 

#### Time-varying effectiveness against a laboratory-confirmed SARS-CoV-2 infection by age group and vaccine manufacturer

&nbsp;

We defined $Y^{(v)}_{t,d,a,g}$ as the number of laboratory confirmed SARS-CoV-2 infections observed on day $t$ for individuals of gender $g$ (male or female)
and age group $a$ (`r str_replace(paste(levels(counts_cases$ageRange), collapse=", "), ", 85", ", or 85")`),
that were fully vaccinated with vaccine $v$ (`r manu_labels[["MOD"]]`, `r manu_labels[["PFR"]]`, or `r manu_labels[["JSN"]]`), $d$ days previous to the positive test. We assumed these counts followed an over-dispersed Poisson distribution with expected rate defined by


\begin{equation}
\mbox{E}\left(Y^{(v)}_{t,d,a,g}\right) = N^{(v)}_{t,d,a,g} \, \mu_{a,g}(t) \, \exp\left\{\beta^{(v)}_{a}(d)\right\}.
(\#eq:model)
\end{equation}

Here $N^{(v)}_{t,d,a,g}$ is the population size on day $t$ of individuals of gender $g$, age group $a$ that were fully vaccinated with vaccine $v$, $d$ days before day $t$, $\mu_{a,g}(t)$ is the incidence rate on date $t$ among the non-vaccinated individuals of gender $g$ and age $a$, and $\beta^{(v)}_{a}(d)$ is the age-specific log relative risk of vaccine $v$, $d$ days after the first dose was administered. Note the the transformation  $f(x) = 1 - \exp(x)$ can be used to convert the $\beta$ (log relative risks) to effectiveness. Since incidence changes across demographic groups and across days of the week (more tests performed on Mondays and less on Sundays, for example) we modeled the $\mu_{a,g}(t)$ as 

$$
\log\{\mu_{a,g}(t) \}=  \alpha_i + f_a(t) + \sum_{w=1}^7 \gamma_{w} 1_{w}(t)  \mbox{ with } \sum_{g=1}^2 \alpha_{g} = 0  \mbox{ and } \sum_{w=1}^7 \gamma_{w} = 0
$$

with $\alpha_{g}$ a gender effect, $f_a(t)$ a cubic-spline representing an age-specific trend that accounts for the 
change in incidence across time, and $1_{w}(t)=1$ indicator functions for each day of the week $w \in \{\mbox{Sunday}, \mbox{Monday}, \dots \mbox{Friday}\}$. To estimate $\mu_{a,g}(t)$ we assumed laboratory-confirmed SARS-CoV-2 infections counts for non-vaccinated individuals, denoted with $Y^{(u)}_{a,g}$, follow a Poisson distribution with rate $\mu_{a,g}(t)$ and  obtained the MLE for all parameters using Iteratively Reweighted Least Square algorithm, as implemented by the _glm_ function in R. We then used these to define the MLE for $\mu_{a,g}(t)$ and denoted it with $\hat{\mu}_{a,g}(t)$. With this estimate in place we then estimated the parameter of interest $\beta_a^{(v)}$ by treating $\mu_{a,g}(t)$ in \@ref(eq:model) as a known value, plugged in $\hat{\mu}_{a,g}(t)$, and noting that 
$\sum_{t} Y^{(v)}_{t,d,a,g}$ follows a Poisson distribution with expected value 

\begin{equation}
\mbox{E}\left\{\sum_{t} Y^{(v)}_{t,d,a,g}\right\} = \left\{\sum_{t} N^{(v)}_{t,d,a,g} \mu_{a,g}(t)\right\} \, \exp\left\{\beta^{(v)}_{a}(d)\right\}.
(\#eq:sum)
\end{equation}

Because the first term on the right is treated as known, if we assume $\beta^{(v)}_{a}(d)$ is a cubic-spline, then the model defined by \@ref(eq:sum) is reduced to a simple generalized linear model and we find the MLE $\beta^{(v)}_{a}(d)$ again using Iteratively Reweighted Least Square.

Note that we can use this model for the hospitalization and deaths outcomes by simply redefining the counts $Y^{(v)}_{t,d,a,g}$ based on counts of these outcomes.

#### COVID-19 hospitalization and death relative risk conditioned on a laboratory confirmed SARS-CoV-2 infection 

&nbsp;

Note: in this section, to avoid introducing more mathematical symbols, we repurpose the $Y, N, \alpha, \beta$ and $\gamma$ notation and, because  we fit a model separately to each age group, we do not use the $a$ index. 

To estimate the further protection provided by the vaccine in reducing hospitalization and deaths among infected individuals we examined the proportion of cases that had hospitalizations or deaths. To do this we defined $N_{i,d}$ as the number of laboratory-confirmed SARS-CoV-2 infections on day $d$ for group $i$. Groups were defined by gender (male or female) and vaccination status (unvaccinated, `r manu_labels[["MOD"]]`, `r manu_labels[["PFR"]]`. or  `r manu_labels[["JSN"]]`).  We defined $Y_{i,d}$ as the number of these that had the hospitalization or death outcome. We then assumed that $Y_{i,d}$ followed a binomial distribution with $N_{i,t}$ trials and success probability $p_{i,d}$ defined by:


$$
\log{\frac{p_{i,d}}{1-p_{i,d}}} = \alpha_{g}  + \beta^{(v)}_{i}(d)  \mbox{ with } \sum_{g=1}^2 \alpha_{g} = 0 
$$


with $\alpha_{g}$ a sex effect and  $\beta_a^{(v)}(d)$ the time-varying conditional risk vaccination status $v$. We fit this model using the Iteratively Reweighted Least Square algorithm. In our analysis we first fit the model without the $\alpha_{g}$ and exclude the `r manu_labels[["JSN"]]` vaccine data  due to small sizes obtained after stratifying by age group, and, for deaths, we combined the  `r manu_labels[["MOD"]]`, or `r manu_labels[["PFR"]]` data. After not finding strong evidence in favor of the need for time-varying effect, we fit a version of the model with $\beta_a^{(v)}(d)$ a constant with respect to $d$ to each vaccine group, but this time including the sex effect and for all three vaccines.


